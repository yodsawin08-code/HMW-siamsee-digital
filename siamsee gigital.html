<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Honda Maliwan Chinese New Year 2026</title>
    
    <link rel="preload" as="image" href="Pok.webp" fetchpriority="high">
    <link rel="preload" as="image" href="logo.png" fetchpriority="high">
    <link rel="preload" as="image" href="shake_item.png" fetchpriority="high">
    <link rel="preload" as="image" href="1.png" fetchpriority="high">
    <link rel="preload" as="image" href="2.png" fetchpriority="high">
    <link rel="preload" as="image" href="3.png" fetchpriority="high">
    <link rel="preload" as="image" href="4.png" fetchpriority="high">
    <link rel="preload" as="image" href="5.png" fetchpriority="high">
    <link rel="preload" as="image" href="6.png" fetchpriority="high">
    <link rel="preload" as="image" href="7.png" fetchpriority="high">
    <link rel="preload" as="image" href="8.png" fetchpriority="high">
    <link rel="preload" as="image" href="9.png" fetchpriority="high">
    
    <script>
        (function() {
            var images = ['Pok.webp', 'logo.png', 'shake_item.png', '1.png', '2.png', '3.png', '4.png', '5.png', '6.png', '7.png', '8.png', '9.png'];
            images.forEach(function(src) { new Image().src = src; });
        })();
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; overscroll-behavior: none; }
        .shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fbbf24' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        .text-outline-black {
            text-shadow: 
                2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }
    </style>
</head>
<body class="bg-red-950">
    <div id="root"></div>

    <script type="text/babel">
        // *** URL Backend ล่าสุด ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxFjKy_w6MCcBbfz9ZE5VCDJGLvnkIyJ5UibQTyEBDqqb6p8fTLZjvKoPqUOVgIjPhQ8w/exec"; 
        const GEMINI_API_KEY = ""; 
        
        const BRANCHES = [ "Online", "สำนักงานใหญ่ (ขอนแก่น)", "สุรินทร์", "บุรีรัมย์", "นาคา (ภูเก็ต)", "เมืองกระบี่" ];

        const FORTUNES = [
            { id: 1, title: 'เริ่มต้นปีด้วยแสงสว่าง', detail: 'สิ่งที่คิดจะกลายเป็นจริง', image: '1.png' },
            { id: 2, title: 'ความสำเร็จเกิดจากมิตรสหาย', detail: 'การเจรจาราบรื่น', image: '2.png' },
            { id: 3, title: 'เป็นปีแห่งการก้าวกระโดด', detail: 'อย่ากลัวที่จะเปลี่ยนแปลง', image: '3.png' },
            { id: 4, title: 'ปัญญาคือทรัพย์', detail: 'สติจะพาให้พ้นอุปสรรค', image: '4.png' },
            { id: 5, title: 'ชีวิตสมดุลคือลาภอันประเสริฐ', detail: 'การงานเด่น ความรักดี', image: '5.png' },
            { id: 6, title: 'โชคลาภหลั่งไหลมาดั่งสายน้ำ', detail: 'มีกินมีใช้ไม่ขาดมือ', image: '6.png' },
            { id: 7, title: 'ชื่อเสียงจะปรากฏเด่นชัด', detail: 'ความดีที่ทำมาจะส่งผล', image: '7.png' },
            { id: 8, title: 'เลขแปดนำพาโชคไม่สิ้นสุด', detail: 'โอกาสใหม่จะวิ่งเข้าหา', image: '8.png' },
            { id: 9, title: 'ถึงจุดสูงสุดของความสมปรารถนา', detail: 'ทุกอย่างเข้าที่เข้าทาง', image: '9.png' }
        ];

        // --- คำนวณโปรโมชั่น (Honda Context) ---
        const getPromotionText = (id) => {
            if (id === 1) return "รับส่วนลด 500 บาท ฟลัชชิ่งแอร์ top up จากส่วนลดแคมเปญหลัก";
            if (id === 5) return "รับส่วนลด 300 บาท บริการล้างหัวฉีด";
            if (id === 9) return "รับส่วนลด 300 บาท บริการเคลือบสี";
            return "-";
        };

        const Icons = {
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Share: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
            Loader: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        };

        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [step, setStep] = useState('branch'); 
            const [selectedBranch, setSelectedBranch] = useState("");
            const [isShaking, setIsShaking] = useState(false);
            const [selectedFortune, setSelectedFortune] = useState(null);
            const [aiAnalysis, setAiAnalysis] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            
            const sessionId = useRef(Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15));
            const targetFortuneRef = useRef(null); 
            const branchRef = useRef(""); 
            const accelerationRef = useRef({ x: 0, y: 0, z: 0 });
            const SHAKE_THRESHOLD = 15;
            const [debugFortuneId, setDebugFortuneId] = useState(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const fortuneId = parseInt(params.get('fortune'));
                if (fortuneId && fortuneId >= 1 && fortuneId <= 9) {
                    targetFortuneRef.current = fortuneId;
                    setDebugFortuneId(fortuneId);
                }
            }, []);

            // --- Save Function ---
            const saveToGoogleSheets = (actionType, fortune, aiText, branchName = null) => {
                const branchToSend = branchName || branchRef.current || selectedBranch;
                const promoText = fortune ? getPromotionText(fortune.id) : "-";

                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sheetName: "Online", 
                        sessionId: sessionId.current,
                        branch: branchToSend,
                        fortuneTitle: fortune ? `ใบที่ ${fortune.id}: ${fortune.title}` : "-",
                        aiBlessing: aiText || "-",
                        action: actionType,
                        promotion: promoText
                    })
                }).catch(err => console.error("Sheet Error:", err));
            };

            const fetchAiContent = async (fortune) => {
                if (!GEMINI_API_KEY) {
                    const defaultMsg = "ขอให้ท่านเฮงๆ รวยๆ สุขภาพแข็งแรงตลอดปี\n(จาก Honda Maliwan)";
                    setAiAnalysis(defaultMsg);
                    return defaultMsg;
                }
                setIsAnalyzing(true);
                try {
                    const prompt = `ขอคำอวยพรสั้นๆสำหรับเซียมซีใบที่ ${fortune.id} ${fortune.title}`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || "เฮงๆ รวยๆ";
                    setAiAnalysis(resultText);
                    return resultText;
                } catch (error) {
                    setAiAnalysis("ดวงดีมีชัย ไปไหนปลอดภัยตลอดเส้นทาง");
                    return "Error API";
                } finally {
                    setIsAnalyzing(false);
                }
            };

            // *** Logic ปุ่มยืนยัน (Online): ส่งครั้งเดียว ***
            const handleBranchConfirm = async () => {
                if (!selectedBranch) return; 

                // ขออนุญาต iOS
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try { await DeviceMotionEvent.requestPermission(); } catch (e) {}
                }
                
                branchRef.current = selectedBranch;
                
                // ตรวจสอบเลขล็อค
                const lockedFortuneId = targetFortuneRef.current;
                if (lockedFortuneId) {
                    const fortuneToShow = FORTUNES.find(f => f.id === lockedFortuneId);
                    if (fortuneToShow) {
                        setSelectedFortune(fortuneToShow);
                        setStep('result');
                        
                        // *** แก้ไข: รอ AI เสร็จก่อนค่อยส่งทีเดียว ***
                        const aiResult = await fetchAiContent(fortuneToShow);
                        saveToGoogleSheets("สแกน QR ดูคำทำนาย", fortuneToShow, aiResult, selectedBranch);
                    }
                } else {
                    setStep('shake');
                }
            };

            // *** Logic เขย่า (Online): ส่งครั้งเดียว ***
            const handleShake = () => {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                        DeviceMotionEvent.requestPermission().catch(console.error);
                }
                setIsShaking(true);
                if (navigator.vibrate) navigator.vibrate(200);
                setTimeout(async () => {
                    setIsShaking(false);
                    const randomFortune = FORTUNES[Math.floor(Math.random() * FORTUNES.length)];
                    setSelectedFortune(randomFortune);
                    setStep('result');
                    
                    // *** แก้ไข: รอ AI เสร็จก่อนค่อยส่งทีเดียว ***
                    const aiResult = await fetchAiContent(randomFortune);
                    saveToGoogleSheets("สุ่มคำทำนาย", randomFortune, aiResult, branchRef.current);
                }, 2000);
            };

            const getImageFile = async () => {
                const response = await fetch(selectedFortune.image);
                const blob = await response.blob();
                return new File([blob], `HondaMaliwan_Fortune_${selectedFortune.id}.png`, { type: 'image/png' });
            };

            const handleDownload = async () => {
                if (!selectedFortune || isProcessing) return;
                setIsProcessing(true);
                try {
                    const file = await getImageFile();
                    const url = window.URL.createObjectURL(file);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = file.name;
                    document.body.appendChild(link);
                    link.click();
                    saveToGoogleSheets("ดาวน์โหลดภาพ", selectedFortune, aiAnalysis, branchRef.current);
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                        setIsProcessing(false);
                    }, 1000);
                } catch (err) {
                    setIsProcessing(false);
                    window.open(selectedFortune.image, '_blank');
                }
            };

            const handleNativeShare = async () => {
                if (!selectedFortune || isProcessing) return;
                setIsProcessing(true);
                try {
                    const file = await getImageFile();
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: 'เซียมซี',
                            text: 'Honda Maliwan',
                            files: [file]
                        });
                        saveToGoogleSheets("แชร์ผ่าน Web Share", selectedFortune, aiAnalysis, branchRef.current);
                    } else {
                        alert("เครื่องนี้ไม่รองรับการแชร์โดยตรง");
                        handleDownload();
                    }
                } catch (err) {
                    console.log("Share failed");
                } finally {
                    setIsProcessing(false);
                }
            };

            // ✅ RENDER SECTION
            if (step === 'branch') {
                return (
                    <div 
                        className="h-[100dvh] w-full bg-cover bg-top bg-no-repeat flex flex-col justify-end items-center relative overflow-hidden"
                        style={{ backgroundImage: "url('Pok.webp')" }}
                    >
                        <div className="z-10 w-full max-w-lg p-6 pb-8 flex flex-col gap-4 animate-fade-in relative">
                             <h2 className="text-xl text-center font-bold text-white text-outline-black whitespace-nowrap">
                                เลือกสาขาที่ท่านใช้บริการ
                             </h2>

                             <div className="relative w-full">
                                <select
                                    value={selectedBranch}
                                    onChange={(e) => setSelectedBranch(e.target.value)}
                                    className="w-full p-4 bg-white/90 border-2 border-yellow-500 rounded-2xl text-red-900 text-lg font-bold focus:outline-none focus:border-red-600 pl-4 pr-10 text-center truncate shadow-lg"
                                >
                                    <option value="" disabled>-- กรุณาเลือก --</option>
                                    {BRANCHES.map(branch => (
                                        <option key={branch} value={branch}>
                                            {branch}
                                        </option>
                                    ))}
                                </select>
                             </div>

                             <button
                                onClick={handleBranchConfirm}
                                disabled={!selectedBranch}
                                className={`w-full py-4 bg-yellow-500 text-red-900 font-bold rounded-full text-xl shadow-xl border-2 border-yellow-300 transition transform ${!selectedBranch ? 'opacity-70 cursor-not-allowed grayscale' : 'hover:scale-105 active:scale-95'}`}
                            >
                                ยืนยัน
                            </button>
                        </div>
                    </div>
                );
            }

            // Step 2 & 3: Shake & Result
            return (
                <div className="h-[100dvh] w-full flex flex-col items-center justify-center p-2 sm:p-4 text-white relative overflow-hidden bg-red-950">
                    
                    <div className="absolute inset-0 opacity-10 pointer-events-none flex justify-center items-center">
                        <span className="text-[20vh] font-bold text-yellow-500 rotate-90 md:rotate-0">HONDA</span>
                    </div>

                    <div className="z-10 w-full max-w-lg bg-red-900/80 backdrop-blur-md p-4 pt-6 pb-2 rounded-3xl border border-yellow-500 shadow-2xl flex flex-col justify-between h-full max-h-[98dvh]">
                        
                        {step === 'shake' && (
                            <div className="text-center mb-2 animate-fade-in flex-shrink-0">
                                <img src="logo.png" alt="HONDA MALIWAN" className="h-16 mx-auto mb-2 drop-shadow-lg" />
                                <p className="text-red-200 text-lg leading-tight">Siamsee Dragon 2026</p>
                            </div>
                        )}

                        {step === 'shake' && (
                            <div className="text-center flex-grow flex flex-col items-center justify-between py-2 overflow-hidden">
                                <div className="flex-1 w-full flex items-center justify-center overflow-hidden relative my-2">
                                    <img 
                                        src="shake_item.png" 
                                        alt="Shake Item" 
                                        className={`h-full w-auto max-w-full object-contain relative z-20 ${isShaking ? 'shake-animation' : ''}`} 
                                    />
                                </div>
                                <div className="flex-shrink-0 w-full flex flex-col items-center justify-end pb-4">
                                    <p className="text-[3dvh] mb-4 font-bold leading-normal text-yellow-100">
                                        ตั้งจิตอธิษฐาน...<br/>แล้วกดเขย่า
                                    </p>
                                    <button 
                                        onClick={handleShake}
                                        disabled={isShaking}
                                        className="w-[80%] max-w-[280px] py-4 bg-yellow-500 text-red-900 font-bold rounded-full text-[2.5dvh] shadow-lg hover:scale-105 transition transform active:scale-95 touch-manipulation"
                                    >
                                        {isShaking ? '...' : 'เขย่าเลย!'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {step === 'result' && selectedFortune && (
                            <div className="text-center animate-fade-in w-full flex flex-col items-center justify-between h-full pb-1 overflow-hidden">
                                
                                <div className="relative flex-1 w-full flex items-center justify-center overflow-hidden min-h-0 mt-0 mb-1">
                                     <img 
                                        src={selectedFortune.image} 
                                        alt={selectedFortune.title} 
                                        loading="eager"
                                        decoding="sync"
                                        fetchpriority="high"
                                        className="h-full w-auto max-w-full object-contain rounded-2xl shadow-2xl border-2 border-yellow-500 relative z-20"
                                    />
                                </div>

                                <div className="w-full flex-shrink-0">
                                    <div className="bg-yellow-500/10 p-1.5 rounded-lg border border-yellow-500/30 mb-1.5 w-full relative z-10 text-center">
                                        <p className="text-yellow-100 italic text-xs leading-tight whitespace-pre-line">
                                            {isAnalyzing ? "กำลังวิเคราะห์ดวงชะตา..." : `${aiAnalysis}`}
                                        </p>
                                    </div>

                                    <div className="flex gap-2 w-full mb-0.5 relative z-10">
                                        <button 
                                            onClick={handleDownload}
                                            disabled={isProcessing}
                                            className="flex-1 flex items-center justify-center gap-1 bg-white/10 hover:bg-white/20 py-1.5 rounded-xl font-bold border border-white/30 transition active:scale-95 text-xs"
                                        >
                                            {isProcessing ? <Icons.Loader /> : <Icons.Download />} 
                                            {isProcessing ? '...' : 'บันทึกภาพ'}
                                        </button>
                                        <button 
                                            onClick={handleNativeShare}
                                            disabled={isProcessing}
                                            className="flex-1 flex items-center justify-center gap-1 bg-yellow-500 text-red-900 hover:bg-yellow-400 py-1.5 rounded-xl font-bold shadow-lg transition active:scale-95 text-xs"
                                        >
                                            {isProcessing ? <Icons.Loader /> : <Icons.Share />}
                                            {isProcessing ? '...' : 'แชร์'}
                                        </button>
                                    </div>

                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="text-yellow-400 underline hover:text-white text-[10px] py-0.5 relative z-10"
                                    >
                                        เล่นใหม่อีกครั้ง
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="mt-1 text-[10px] text-red-400/60 text-center absolute bottom-0.5 pointer-events-none w-full">
                        © 2026 Honda Maliwan 
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
