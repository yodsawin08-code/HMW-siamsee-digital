<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Honda Maliwan Chinese New Year 2026</title>
    
    <script>
        (function() {
            var userAgent = navigator.userAgent || navigator.vendor || window.opera;
            var isLine = /Line/i.test(userAgent);
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô LINE ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
            if (isLine) {
                var url = new URL(window.location.href);
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Loop
                if (!url.searchParams.has('openExternalBrowser')) {
                    url.searchParams.set('openExternalBrowser', '1');
                    window.location.replace(url.toString());
                }
            }
        })();
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; overscroll-behavior: none; }
        .shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
    </style>
</head>
<body class="bg-red-950">
    <div id="root"></div>

    <script type="text/babel">
        // --- URL Backend (‡∏ä‡∏µ‡∏ó Offline) ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-RvUzajF0Sa7_J2RxAydWPsd8J4hdjaMuhgO9mWRzcmk1sAFEYUtEqtfh2Km4qCGJng/exec"; 
        const GEMINI_API_KEY = ""; 
        
        const BRANCHES = [ "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà (‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô)", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏ô‡∏≤‡∏Ñ‡∏≤ (‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï)", "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "Online" ];

        const FORTUNES = [
            { id: 1, title: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á', detail: '‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏õ‡∏£‡∏∞‡∏î‡∏∏‡∏à‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏≠‡∏∏‡∏ó‡∏±‡∏¢ ‡πÑ‡∏£‡πâ‡πÄ‡∏°‡∏Ü‡∏´‡∏°‡∏≠‡∏Å‡∏ö‡∏±‡∏á', image: '1.png' },
            { id: 2, title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏°‡∏¥‡∏ï‡∏£‡∏™‡∏´‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏Ñ‡∏£‡∏≠‡∏á', detail: '‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏£‡∏≤‡∏ö‡∏£‡∏∑‡πà‡∏ô ‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ñ‡∏≠‡∏¢‡πÄ‡∏Å‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡∏ù‡∏±‡πà‡∏á‡∏ù‡∏±‡∏ô', image: '2.png' },
            { id: 3, title: '‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πâ‡∏≤‡∏ß‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î', detail: '‡∏≠‡∏¢‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏∞‡∏ô‡∏≥‡∏°‡∏≤‡∏ã‡∏∂‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•', image: '3.png' },
            { id: 4, title: '‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', detail: '‡∏™‡∏ï‡∏¥‡∏à‡∏∞‡∏û‡∏≤‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏á', image: '4.png' },
            { id: 5, title: '‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Ñ‡∏∑‡∏≠‡∏•‡∏≤‡∏†‡∏≠‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê', detail: '‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏î‡∏µ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏¢‡πÉ‡∏à‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏î‡∏±‡πà‡∏á‡∏†‡∏π‡∏ú‡∏≤', image: '5.png' },
            { id: 6, title: '‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡∏´‡∏•‡∏±‡πà‡∏á‡πÑ‡∏´‡∏•‡∏°‡∏≤‡∏î‡∏±‡πà‡∏á‡∏™‡∏≤‡∏¢‡∏ô‡πâ‡∏≥', detail: '‡∏°‡∏µ‡∏Å‡∏¥‡∏ô‡∏°‡∏µ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î‡∏°‡∏∑‡∏≠ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î‡∏à‡∏∞‡∏Ñ‡∏•‡∏µ‡πà‡∏Ñ‡∏•‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏ß‡∏±‡∏ô', image: '6.png' },
            { id: 7, title: '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î', detail: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏°‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏ç', image: '7.png' },
            { id: 8, title: '‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏î‡∏ô‡∏≥‡∏û‡∏≤‡πÇ‡∏ä‡∏Ñ‡πÑ‡∏°‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', detail: '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤ ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡∏à‡∏∞‡∏ô‡∏≥‡∏°‡∏≤‡∏ã‡∏∂‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', image: '8.png' },
            { id: 9, title: '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏õ‡∏£‡∏≤‡∏£‡∏ñ‡∏ô‡∏≤', detail: '‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≤‡∏á ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô', image: '9.png' }
        ];

        const Icons = {
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Share: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
            Loader: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        };

        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [step, setStep] = useState('branch'); 
            const [selectedBranch, setSelectedBranch] = useState("");
            const [selectedFortune, setSelectedFortune] = useState(null);
            const [aiAnalysis, setAiAnalysis] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isShaking, setIsShaking] = useState(false);
            
            // ‡πÉ‡∏ä‡πâ Ref ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
            const targetFortuneRef = useRef(null); 
            const branchRef = useRef(""); 
            const sessionId = useRef(Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15));
            const [debugFortuneId, setDebugFortuneId] = useState(null); 

            // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å URL ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà App ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const fortuneId = parseInt(params.get('fortune'));
                if (fortuneId && fortuneId >= 1 && fortuneId <= 9) {
                    targetFortuneRef.current = fortuneId;
                    setDebugFortuneId(fortuneId);
                }
            }, []);

            const saveToGoogleSheets = (actionType, fortune, aiText, branchName = null) => {
                const branchToSend = branchName || branchRef.current || selectedBranch;
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sheetName: "Offline", 
                        sessionId: sessionId.current,
                        branch: branchToSend,
                        fortuneTitle: fortune ? `‡πÉ‡∏ö‡∏ó‡∏µ‡πà ${fortune.id}: ${fortune.title}` : "-",
                        aiBlessing: aiText || "-",
                        action: actionType 
                    })
                }).then(() => console.log(`Action saved: ${actionType} | AI: ${aiText}`));
            };

            const fetchAiContent = async (fortune) => {
                if (!GEMINI_API_KEY) {
                    setAiAnalysis("‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Æ‡∏á‡πÜ ‡∏£‡∏ß‡∏¢‡πÜ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ (‡∏à‡∏≤‡∏Å Honda Maliwan)");
                    return "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Æ‡∏á‡πÜ ‡∏£‡∏ß‡∏¢‡πÜ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ (‡∏à‡∏≤‡∏Å Honda Maliwan)"; // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ
                }
                
                setIsAnalyzing(true);
                try {
                    const prompt = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ‡πÉ‡∏ö‡∏ó‡∏µ‡πà ${fortune.id} ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${fortune.title}" ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î "${fortune.detail}" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Honda Maliwan ‡∏™‡∏≤‡∏Ç‡∏≤ ${selectedBranch} ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏™‡∏±‡πâ‡∏ô‡πÜ 1 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏á‡∏Ñ‡∏•`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÄ‡∏Æ‡∏á‡πÜ ‡∏£‡∏ß‡∏¢‡πÜ";
                    setAiAnalysis(resultText);
                    return resultText; // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ
                } catch (error) {
                    console.error("AI Error", error);
                    const errorText = "‡∏î‡∏ß‡∏á‡∏î‡∏µ‡∏°‡∏µ‡∏ä‡∏±‡∏¢ ‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á";
                    setAiAnalysis(errorText);
                    return errorText;
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const handleBranchSelect = async (branch) => {
                setSelectedBranch(branch);
                branchRef.current = branch; 
                
                const lockedFortuneId = targetFortuneRef.current;
                let fortuneToShow = null;

                if (lockedFortuneId) {
                    fortuneToShow = FORTUNES.find(f => f.id === lockedFortuneId);
                } else {
                    fortuneToShow = FORTUNES[Math.floor(Math.random() * FORTUNES.length)];
                }

                if (fortuneToShow) {
                    setSelectedFortune(fortuneToShow);
                    setStep('result');
                    
                    // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å: ‡∏£‡∏≠ AI...
                    saveToGoogleSheets("‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏î‡∏π‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢", fortuneToShow, "‡∏£‡∏≠ AI...", branch);
                    
                    // 2. ‡∏£‡∏≠ AI ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
                    const aiResult = await fetchAiContent(fortuneToShow);

                    // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á: ‡∏™‡πà‡∏á‡∏ú‡∏• AI ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï!
                    if (aiResult) {
                         saveToGoogleSheets("AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô", fortuneToShow, aiResult, branch);
                    }
                }
            };

            const handleShake = () => {
                setIsShaking(true);
                setTimeout(async () => {
                    setIsShaking(false);
                    const randomFortune = FORTUNES[Math.floor(Math.random() * FORTUNES.length)];
                    setSelectedFortune(randomFortune);
                    setStep('result');
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
                    saveToGoogleSheets("‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢", randomFortune, "‡∏£‡∏≠ AI...", branchRef.current);
                    
                    // ‡∏£‡∏≠ AI ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥
                    const aiResult = await fetchAiContent(randomFortune);
                    if (aiResult) {
                         saveToGoogleSheets("AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô", randomFortune, aiResult, branchRef.current);
                    }
                }, 2000);
            };

            const getImageFile = async () => {
                const response = await fetch(selectedFortune.image + '?t=' + new Date().getTime());
                if (!response.ok) throw new Error("Image not found");
                const blob = await response.blob();
                return new File([blob], `HondaMaliwan_Fortune_${selectedFortune.id}.png`, { type: 'image/png' });
            };

            const handleDownload = async () => {
                if (!selectedFortune || isProcessing) return;
                setIsProcessing(true);

                try {
                    const file = await getImageFile();
                    const url = window.URL.createObjectURL(file);
                    const link = document.createElement('a');
                    link.style.display = 'none';
                    link.href = url;
                    link.download = file.name;
                    document.body.appendChild(link);
                    link.click();
                    
                    saveToGoogleSheets("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û", selectedFortune, aiAnalysis, branchRef.current);
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                        setIsProcessing(false);
                    }, 2000); 
                } catch (err) {
                    console.error("Download failed:", err);
                    setIsProcessing(false);
                    window.open(selectedFortune.image, '_blank');
                }
            };

            const handleNativeShare = async () => {
                if (!selectedFortune || isProcessing) return;
                setIsProcessing(true);

                try {
                    const file = await getImageFile();
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: '‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• Honda Maliwan',
                            text: `‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ "${selectedFortune.title}" ‡πÄ‡∏Æ‡∏á‡∏°‡∏≤‡∏Å! üéâ`,
                            files: [file]
                        });
                        saveToGoogleSheets("‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô Web Share", selectedFortune, aiAnalysis, branchRef.current);
                    } else {
                        alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                        setIsProcessing(false); 
                        handleDownload();
                    }
                } catch (err) {
                    console.log("Share cancelled or failed:", err);
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div className="h-[100dvh] w-full flex flex-col items-center justify-center p-2 sm:p-4 text-white relative overflow-hidden">
                    
                    <div className="absolute inset-0 opacity-10 pointer-events-none flex justify-center items-center">
                        <span className="text-[20vh] font-bold text-yellow-500 rotate-90 md:rotate-0">HONDA</span>
                    </div>

                    <div className="z-10 w-full max-w-lg bg-red-900/80 backdrop-blur-md p-4 pt-6 pb-2 rounded-3xl border border-yellow-500 shadow-2xl flex flex-col justify-between h-full max-h-[98dvh]">
                        
                        {step !== 'result' && (
                            <div className="text-center mb-2 animate-fade-in flex-shrink-0">
                                <img src="logo.png" alt="HONDA MALIWAN" className="h-20 mx-auto mb-2 drop-shadow-lg" />
                                <p className="text-red-200 text-lg leading-tight">Siamsee Dragon 2026</p>
                                {debugFortuneId && (
                                    <div className="mt-1 inline-block bg-yellow-500/20 px-3 py-1 rounded-full border border-yellow-500/30">
                                        <p className="text-yellow-400 text-xs font-bold">üéØ ‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ö‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ‡∏ó‡∏µ‡πà {debugFortuneId}</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {step === 'branch' && (
                            <div className="animate-fade-in w-full flex-grow flex flex-col justify-center">
                                <h2 className="text-xl text-center mb-5 font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
                                <div className="space-y-3">
                                    {BRANCHES.map(branch => (
                                        <button 
                                            key={branch}
                                            onClick={() => handleBranchSelect(branch)}
                                            className="w-full py-3 px-6 bg-white/10 hover:bg-yellow-500 hover:text-red-900 border border-yellow-500/30 rounded-2xl transition duration-300 font-bold text-lg active:scale-95 touch-manipulation leading-tight"
                                        >
                                            {branch}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {step === 'shake' && (
                            // ‡πÉ‡∏ä‡πâ flex-grow ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∂‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞ justify-between ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢
                            <div className="text-center flex-grow flex flex-col items-center justify-between py-2">
                                {/* Wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà (flex-1) ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô (overflow-hidden) */}
                                <div className="flex-1 w-full flex items-center justify-center overflow-hidden relative my-2">
                                    {/* ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏° parent (h-full) ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ö (object-contain) */}
                                    <img 
                                        src="shake_item.png" 
                                        alt="Shake Item" 
                                        className={`h-full w-auto max-w-full object-contain relative z-20 ${isShaking ? 'shake-animation' : ''}`} 
                                    />
                                </div>

                                <div className="flex-shrink-0 w-full">
                                    <p className="text-[3dvh] font-bold leading-tight text-yellow-100 mb-4">
                                        ‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏¥‡∏ï‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô...<br/>‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏Ç‡∏¢‡πà‡∏≤
                                    </p>
                                    <button 
                                        onClick={handleShake}
                                        disabled={isShaking}
                                        className="w-[80%] max-w-[300px] py-3 bg-yellow-500 text-red-900 font-bold rounded-full text-[2.5dvh] shadow-lg hover:scale-105 transition transform active:scale-95 touch-manipulation"
                                    >
                                        {isShaking ? '...' : '‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡πÄ‡∏•‡∏¢!'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {step === 'result' && selectedFortune && (
                            <div className="text-center animate-fade-in w-full flex flex-col items-center justify-between h-full pb-2">
                                {/* Logo is hidden here because step === 'result' */}
                                
                                <div className="relative w-full flex-1 flex items-center justify-center overflow-hidden my-2">
                                     <img 
                                        src={selectedFortune.image} 
                                        alt={selectedFortune.title} 
                                        className="h-full w-auto max-w-full object-contain rounded-2xl shadow-2xl border-2 border-yellow-500 relative z-20"
                                    />
                                </div>

                                <div className="w-full flex-shrink-0">
                                    <div className="bg-yellow-500/20 p-3 rounded-xl border border-yellow-500/50 mb-3 w-full relative z-10">
                                        <h4 className="text-yellow-400 text-sm font-bold mb-1 leading-tight">‚ú® ‡∏û‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏≤‡∏Å‡∏°‡∏±‡∏á‡∏Å‡∏£‡∏ó‡∏≠‡∏á</h4>
                                        <p className="text-white italic text-sm leading-tight">
                                            {isAnalyzing ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤..." : `"${aiAnalysis}"`}
                                        </p>
                                    </div>

                                    <div className="flex gap-2 w-full mb-2 relative z-10">
                                        <button 
                                            onClick={handleDownload}
                                            disabled={isProcessing}
                                            className="flex-1 flex items-center justify-center gap-2 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold border border-white/30 transition active:scale-95 text-sm"
                                        >
                                            {isProcessing ? <Icons.Loader /> : <Icons.Download />} 
                                            {isProcessing ? '...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û'}
                                        </button>
                                        <button 
                                            onClick={handleNativeShare}
                                            disabled={isProcessing}
                                            className="flex-1 flex items-center justify-center gap-2 bg-yellow-500 text-red-900 hover:bg-yellow-400 py-3 rounded-xl font-bold shadow-lg transition active:scale-95 text-sm"
                                        >
                                            {isProcessing ? <Icons.Loader /> : <Icons.Share />}
                                            {isProcessing ? '...' : '‡πÅ‡∏ä‡∏£‡πå'}
                                        </button>
                                    </div>

                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="text-yellow-400 underline hover:text-white text-xs py-1 relative z-10"
                                    >
                                        ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="mt-2 text-xs text-red-400/60 text-center absolute bottom-1 pointer-events-none">
                        ¬© 2026 Honda Maliwan | Powered by Gemini & Google Sheets
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
